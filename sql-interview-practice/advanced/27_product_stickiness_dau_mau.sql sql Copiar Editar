-- üìà Task 27: Stickiness ‚Äî DAU / MAU (%)

-- –ú–µ—Ç–∞: –æ—Ü—ñ–Ω–∏—Ç–∏, –Ω–∞—Å–∫—ñ–ª—å–∫–∏ —á–∞—Å—Ç–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å—Å—è –¥–æ –ø—Ä–æ–¥—É–∫—Ç—É.

-- Table: events(user_id, event_date)

WITH daily AS (
  SELECT DATE(event_date) AS day,
         COUNT(DISTINCT user_id) AS dau
  FROM events
  GROUP BY day
),
monthly AS (
  SELECT DATE_TRUNC('month', event_date) AS month,
         COUNT(DISTINCT user_id) AS mau
  FROM events
  GROUP BY month
),
dau_with_month AS (
  SELECT DATE(event_date) AS day,
         DATE_TRUNC('month', event_date) AS month,
         user_id
  FROM events
),
stickiness AS (
  SELECT m.month,
         COUNT(DISTINCT d.day) AS active_days,
         m.mau
  FROM monthly m
  JOIN daily d ON DATE_TRUNC('month', d.day) = m.month
)
SELECT *,
       ROUND(active_days * 100.0 / 30, 1) AS approx_dau_avg,
       ROUND((active_days / 30.0) * 100, 2) AS stickiness_pct
FROM stickiness;
